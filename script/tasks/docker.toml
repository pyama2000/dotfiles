[tasks.setup_docker.mac]
category = "Docker"
description = "Install Docker"
dependencies = ["setup_lima", "install_docker", "install_docker-compose", "install_docker-buildx"]
script = [
'''
#!/usr/bin/env bash
set -eux -o pipefail

CONTEXT_NAME='lima-docker'
CONTEXT_DESCRIPTION='Use lima docker'
CONTEXT_DOCKER_HOST="unix://$HOME/.lima/docker/sock/docker.sock"
CONTEXT_DEFAULT_STACK_ORCHESTRATOR='swarm'

docker context create "$CONTEXT_NAME" \
  --description "$CONTEXT_DESCRIPTION" \
  --docker host="$CONTEXT_DOCKER_HOST" \
  --default-stack-orchestrator="$CONTEXT_DEFAULT_STACK_ORCHESTRATOR"

docker context use "$CONTEXT_NAME"
'''
]

[tasks.update_docker_cli_plugins.mac]
category = "Docker"
description = "Update docker CLI plugins"
run_task = [{ name = ["update_docker-compose", "update_docker-buildx"] }]

[tasks.setup_lima.mac]
private = true
dependencies = ["install_lima", "upgrade_filedescriptor"]
script = [
'''
#!/usr/bin/env bash
set -eux -o pipefail

limactl start ~/dotfiles/lima/docker.yml
'''
]

[tasks.install_lima.mac]
private = true
script = [
'''
#!/usr/bin/env bash
set -eux -o pipefail

brew install lima
'''
]

[tasks.upgrade_filedescriptor.mac]
private = true
condition = { profiles = ["production"] }
script = [
'''
#!/usr/bin/env bash
set -eux -o pipefail

ln -snfv ~/dotfiles/lima/limit.maxfiles.plist /Library/LaunchDaemons
sudo chown root /Library/LaunchDaemons/limit.maxfiles.plist
sudo launchctl load -w /Library/LaunchDaemons/limit.maxfiles.plist
'''
]

[tasks.install_docker.mac]
private = true
script = [
'''
#!/usr/bin/env bash
set -eux -o pipefail

brew install docker
'''
]

[tasks.install_docker-compose.mac]
private = true
script = [
'''
#!/usr/bin/env bash
set -eux -o pipefail

WORKDIR='/tmp/docker-compose'
mkdir -p "$WORKDIR"

curl -sL https://api.github.com/repos/docker/compose/releases/latest \
  | jq -r '.assets[].browser_download_url' \
  | grep -E "docker-compose-darwin-x86_64\$" \
  | xargs -I DOWNLOAD_URL curl -Lfso "$WORKDIR"/docker-compose DOWNLOAD_URL

sudo chmod +x "$WORKDIR/docker-compose"
cp "$WORKDIR/docker-compose" /usr/local/bin

mkdir -p ~/.docker/cli-plugins
ln -snfv /usr/local/bin/docker-compose ~/.docker/cli-plugins

rm -rf "$WORKDIR"
'''
]

[tasks.update_docker-compose.mac]
private = true
alias = "install_docker-compose"

[tasks.install_docker-buildx.mac]
private = true
script = [
'''
#!/usr/bin/env bash
set -eux -o pipefail

DOWNLOAD_BINARY_TMP_PATH='/tmp/docker-buildx'

curl -sL https://api.github.com/repos/docker/buildx/releases/latest \
  | jq -r '.assets[].browser_download_url' \
  | grep -E "buildx-v[0-9]+.[0-9]+.[0-9]+\.darwin-amd64" \
  | xargs curl -Lfo "$DOWNLOAD_BINARY_TMP_PATH"

sudo chmod +x "$DOWNLOAD_BINARY_TMP_PATH"

mkdir -p $HOME/.docker/cli-plugins
cp "$DOWNLOAD_BINARY_TMP_PATH" $HOME/.docker/cli-plugin

rm "$DOWNLOAD_BINARY_TMP_PATH"
'''
]

[tasks.update_docker-buildx.mac]
private = true
alias = "install_docker-buildx"
